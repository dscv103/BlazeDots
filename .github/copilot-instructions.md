# GitHub Copilot Coding Agent Instructions - BlazeDots

## Repository Summary

**BlazeDots** is a hardened NixOS system configuration repository targeting the "blazar" host. This is a **Nix flake-based** configuration (~500 lines) that provides a complete desktop environment with Wayland (Niri), secret management (SOPS), disk encryption (LUKS2), and impermanence. The repository follows a modular architecture with strict formatting and validation requirements.

**Tech Stack:**
- **Language**: Nix (configuration language)
- **Target System**: NixOS (Linux distribution)  
- **Architecture**: Flake-parts with modular NixOS modules
- **Key Dependencies**: nixpkgs (unstable), home-manager, sops-nix, disko, impermanence, noctalia-shell
- **Secrets**: SOPS with AGE encryption
- **CI/CD**: GitHub Actions with formatting, linting, and build validation

## Build and Validation Workflow

### Essential Commands (in order of frequency)

**Formatting (ALWAYS run before committing):**
```bash
nix fmt                    # Format all Nix/Markdown/YAML files via treefmt
```

**Validation Sequence:**
```bash
nix flake metadata         # Verify flake structure
nix flake check --all-systems  # Run all checks (formatting, linting)
nix eval .#nixosConfigurations."blazar".config.system.build.toplevel.drvPath  # Test evaluation
sudo nixos-rebuild build --flake .#blazar  # Build system (requires NixOS)
```

**Development Environment:**
```bash
# Option 1: Using devenv (preferred if available)
nix profile install nixpkgs#direnv nixpkgs#devenv  # Once per machine
echo 'use devenv' > .envrc && direnv allow         # Enable auto-shell
devenv shell                                        # Manual activation

# Option 2: Direct nix shell
nix develop                                         # Enter development shell
```

### CI/CD Pipeline

The repository runs **two GitHub Actions workflows:**

1. **nix-ci.yml** (primary validation):
   - Runs `nix flake check --impure --all-systems`
   - Enforces formatting with `nix fmt` (fails if files need formatting)
   - Evaluates system derivation for correctness

2. **nixos-build.yml** (build verification):
   - Discovers all nixosConfigurations
   - Builds each system closure
   - Exports system as `.nar` artifact

**Common CI Failures & Fixes:**
- **Formatting errors**: Run `nix fmt` locally and commit
- **Mixed quotes in YAML**: Use double quotes consistently  
- **Trailing whitespace**: Let prettier (via treefmt) fix automatically
- **Hash placeholders**: Replace `lib.fakeSha256` with real hash via `nix store prefetch-file "<URL>" --json | jq -r '.hash'`

## Project Architecture & Key Locations

### Core Structure
```
├── flake.nix                 # Main flake definition with inputs/outputs
├── hosts/blazar/            # Host-specific configuration
│   ├── default.nix          # Main host config imports all modules
│   ├── hardware-configuration.nix  # Generated hardware profile
│   └── modules/             # Host-specific modules (disko, etc.)
├── nix/
│   ├── modules/nixos/       # Reusable NixOS modules
│   │   ├── base.nix         # User accounts, base system config
│   │   ├── desktop.nix      # GUI applications, window manager
│   │   ├── sops.nix         # Secret management setup
│   │   └── *.nix           # Other system modules
│   └── parts/              # Flake-parts configuration
│       ├── fmt.nix         # Formatting/linting setup (treefmt)
│       └── *.nix           # Other flake parts
├── homes/dscv/             # Home Manager configuration
├── scripts/                # Utility scripts (SOPS setup, etc.)
└── docs/                  # Documentation (SOPS guide)
```

### Configuration Flow
1. `flake.nix` defines inputs and creates `nixosConfigurations."blazar"`
2. `hosts/blazar/default.nix` imports hardware config + system modules
3. System modules in `nix/modules/nixos/` provide functionality
4. Home Manager config in `homes/dscv/` handles user environment
5. Secrets managed via SOPS with keys at `/var/lib/sops-nix/key.txt`

### Key Files to Modify
- **System config**: `nix/modules/nixos/*.nix`
- **User config**: `homes/dscv/home.nix`  
- **Host-specific**: `hosts/blazar/default.nix`
- **Scripts**: `scripts/` (especially `sops-setup.sh`)
- **CI/workflows**: `.github/workflows/*.yml`

### Files to NEVER modify
- `flake.lock` (managed by `nix flake update`)
- `hosts/blazar/hardware-configuration.nix` (generated by `nixos-generate-config`)
- Any file marked with `# @managed-by: nixos-config-generator`

## Critical Gotchas & Troubleshooting

### Formatting Requirements
**treefmt** is STRICT and CI will fail if files are not properly formatted:
- **Nix files**: Use `nixfmt` formatting (2-space indent, specific spacing)
- **YAML/JSON**: Use `prettier` with double quotes, no trailing whitespace  
- **Markdown**: Consistent formatting via prettier

**Fix formatting issues**: Always run `nix fmt` before committing.

### SOPS Secrets Management
- Private key MUST be at `/var/lib/sops-nix/key.txt` (600 permissions)
- Use `scripts/sops-setup.sh` for initial setup
- Edit secrets with `sops secrets/secrets.yaml`
- NEVER commit plaintext secrets
- For new secrets, add to `.sops.yaml` creation rules

### Hash Management
- Replace `lib.fakeSha256` with real hashes using: `nix store prefetch-file "<URL>" --json | jq -r '.hash'`
- Common in package definitions when adding new software

### Impermanence System
- Only `/persist` survives reboots 
- Critical state automatically persisted via `nix/modules/nixos/impermanence.nix`
- Home Manager handles user-level persistence

### Build Environment
- **Nix required**: Cannot build without Nix installed and flakes enabled
- **System builds need NixOS**: `sudo nixos-rebuild` only works on NixOS systems  
- **Development**: Use `devenv shell` or `nix develop` for tooling (statix, deadnix, sops, age)

### Installation Context
This is a **complete system configuration** - not a typical software project:
- Deploys to bare metal with disk encryption and custom partitioning
- Uses Disko for destructive disk provisioning (`hosts/blazar/modules/disko.nix`)
- Installation involves `nixos-install --flake .#blazar`

**Trust these instructions** - only search for information if instructions are incomplete or incorrect. The repository follows standard NixOS patterns with SOPS integration.